<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Earthquake Information</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet-search/dist/leaflet-search.min.css">
    <style>
        #map { height: 500px; }
        #status-bar { position: fixed; bottom: 0; width: 100%; background: #f8f9fa; padding: 10px; text-align: center; border-top: 1px solid #ddd; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="text-center">Earthquake Information</h1>
        <div id="status-bar">Status: Ready</div>
        <div id="map"></div>
        <div id="earthquakeTable" class="mt-4"></div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.21/js/dataTables.bootstrap4.min.js"></script>
    <script src="https://unpkg.com/leaflet-search/dist/leaflet-search.min.js"></script>
    <script>
        const statusBar = document.getElementById('status-bar');
        const map = L.map('map').setView([37.7749, -122.4194], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
        }).addTo(map);

        let earthquakeMarkers = [];
        const markerLayer = L.layerGroup().addTo(map);
        const searchControl = new L.Control.Search({
            layer: markerLayer,
            propertyName: 'title',
            moveToLocation: function(latlng, title, map) {
                map.setView(latlng, 8); // set the zoom level
            }
        }).addTo(map);

        const updateStatus = (message) => {
            statusBar.textContent = message;
        };

        const fetchEarthquakeData = () => {
            updateStatus('Fetching earthquake data...');
            $.getJSON('https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_hour.geojson', function(data) {
                updateStatus('Data fetched successfully');
                updateMap(data.features);
                updateTable(data.features);
            }).fail(function() {
                updateStatus('Failed to fetch data');
            });
        };

        const updateMap = (earthquakes) => {
            markerLayer.clearLayers();
            earthquakeMarkers = [];
            earthquakes.forEach(quake => {
                const coords = quake.geometry.coordinates;
                const latLng = [coords[1], coords[0]];
                const marker = L.marker(latLng).addTo(markerLayer);
                marker.bindPopup(`<strong>Magnitude:</strong> ${quake.properties.mag}<br><strong>Location:</strong> ${quake.properties.place}`);
                marker.options.title = quake.properties.place;
                earthquakeMarkers.push(marker);
            });
            searchControl.indexSync();
        };

        const updateTable = (earthquakes) => {
            const tableDiv = $('#earthquakeTable');
            tableDiv.empty();
            let table = '<table id="quakeTable" class="table table-striped table-bordered"><thead><tr><th>Time</th><th>Magnitude</th><th>Location</th></tr></thead><tbody>';
            earthquakes.forEach(quake => {
                const time = new Date(quake.properties.time).toLocaleString();
                const mag = quake.properties.mag;
                const place = quake.properties.place;
                table += `<tr data-lat="${quake.geometry.coordinates[1]}" data-lng="${quake.geometry.coordinates[0]}" data-mag="${mag}" data-place="${place}"><td>${time}</td><td>${mag}</td><td>${place}</td></tr>`;
            });
            table += '</tbody></table>';
            tableDiv.append(table);
            $('#quakeTable').DataTable({
                "pageLength": 5,
                "lengthMenu": [5, 20, 50, 100],
                "pagingType": "full_numbers"
            });

            $('#quakeTable tbody').on('click', 'tr', function() {
                const lat = $(this).data('lat');
                const lng = $(this).data('lng');
                const mag = $(this).data('mag');
                const place = $(this).data('place');
                const latLng = [lat, lng];
                const popupContent = `<strong>Magnitude:</strong> ${mag}<br><strong>Location:</strong> ${place}`;
                L.popup()
                    .setLatLng(latLng)
                    .setContent(popupContent)
                    .openOn(map);
                map.setView(latLng, 8);
            });
        };

        map.on('mousemove', function(e) {
            updateStatus(`Latitude: ${e.latlng.lat.toFixed(4)}, Longitude: ${e.latlng.lng.toFixed(4)}`);
        });

        setInterval(fetchEarthquakeData, 300000); // 5 minutes
        fetchEarthquakeData();
    </script>
</body>
</html>