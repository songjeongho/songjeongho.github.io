<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Earthquake Map</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        .marker { background-image: url('https://docs.mapbox.com/mapbox-gl-js/assets/custom_marker.png'); background-size: cover; width: 50px; height: 50px; cursor: pointer; }
        .mapboxgl-popup { max-width: 400px; }
        .mapboxgl-popup-content { text-align: center; font-family: 'Open Sans', sans-serif; }
        .status-bar { position: fixed; bottom: 0; width: 100%; background-color: #333; color: white; text-align: center; padding: 10px; }
        .zoom-return { display: none; position: fixed; bottom: 50px; right: 50px; z-index: 1; }
        .pagination { justify-content: center; }
    </style>
</head>
<body>

<div class="container">
    <h1 class="mt-4">Earthquake Information</h1>
    <div class="status-bar" id="status-bar">Loading...</div>
    <div class="zoom-return" id="zoom-return">
        <button class="btn btn-primary">Return</button>
    </div>
    <div class="form-group">
        <label for="rows-per-page">Rows per page:</label>
        <select id="rows-per-page" class="form-control" style="width: auto; display: inline-block;">
            <option value="5">5</option>
            <option value="20">20</option>
            <option value="50">50</option>
            <option value="100">100</option>
        </select>
    </div>
    <table class="table table-bordered" id="earthquake-table">
        <thead>
            <tr>
                <th>Location</th>
                <th>Magnitude</th>
                <th>Time</th>
            </tr>
        </thead>
        <tbody>
            <!-- Earthquake data will be inserted here -->
        </tbody>
    </table>
    <nav>
        <ul class="pagination" id="pagination">
            <!-- Pagination buttons will be inserted here -->
        </ul>
    </nav>
    <div>Displaying <span id="total-count"></span> results</div>
</div>
<div id='map'></div>

<script src='https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.js'></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiaGQ3MzA3aDEiLCJhIjoiY2x4YnB5OXdzMnZieDJpcXhva2JqOGE5MiJ9.tnktvNciVGN2XVDPFEwCLA';

    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v11',
        center: [-98.5795, 39.8283],
        zoom: 3
    });

    const statusBar = document.getElementById('status-bar');
    const zoomReturnBtn = document.getElementById('zoom-return');
    let earthquakeData = [];
    let currentPage = 1;
    let rowsPerPage = 5;

    async function fetchEarthquakeData() {
        const response = await fetch('https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_hour.geojson');
        const data = await response.json();
        earthquakeData = data.features;
        updateTable();
        updateMap();
        statusBar.textContent = 'Data loaded';
    }

    function updateTable() {
        const tableBody = document.getElementById('earthquake-table').querySelector('tbody');
        tableBody.innerHTML = '';
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const pageData = earthquakeData.slice(start, end);

        pageData.forEach(earthquake => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${earthquake.properties.place}</td>
                <td>${earthquake.properties.mag}</td>
                <td>${new Date(earthquake.properties.time).toLocaleString()}</td>
            `;
            row.style.cursor = 'pointer';
            row.addEventListener('click', () => {
                const coordinates = earthquake.geometry.coordinates;
                map.flyTo({ center: [coordinates[0], coordinates[1]], zoom: 8 });
                zoomReturnBtn.style.display = 'block';
            });
            tableBody.appendChild(row);
        });

        updatePagination();
        document.getElementById('total-count').textContent = earthquakeData.length;
    }

    function updateMap() {
        earthquakeData.forEach(earthquake => {
            const coordinates = earthquake.geometry.coordinates;
            const marker = new mapboxgl.Marker({ element: createMarkerElement() })
                .setLngLat([coordinates[0], coordinates[1]])
                .setPopup(new mapboxgl.Popup().setHTML(createPopupContent(earthquake)))
                .addTo(map);
        });
    }

    function createMarkerElement() {
        const el = document.createElement('div');
        el.className = 'marker';
        return el;
    }

    function createPopupContent(earthquake) {
        return `
            <h3>${earthquake.properties.place}</h3>
            <p>Magnitude: ${earthquake.properties.mag}</p>
            <p>Time: ${new Date(earthquake.properties.time).toLocaleString()}</p>
        `;
    }

    map.on('mousemove', (e) => {
        statusBar.textContent = `Lat: ${e.lngLat.lat.toFixed(4)}, Lng: ${e.lngLat.lng.toFixed(4)}`;
    });

    zoomReturnBtn.addEventListener('click', () => {
        map.flyTo({ center: [-98.5795, 39.8283], zoom: 3 });
        zoomReturnBtn.style.display = 'none';
    });

    function updatePagination() {
        const pagination = document.getElementById('pagination');
        pagination.innerHTML = '';

        const pageCount = Math.ceil(earthquakeData.length / rowsPerPage);
        for (let i = 1; i <= pageCount; i++) {
            const pageItem = document.createElement('li');
            pageItem.className = 'page-item' + (i === currentPage ? ' active' : '');
            const pageLink = document.createElement('a');
            pageLink.className = 'page-link';
            pageLink.href = '#';
            pageLink.textContent = i;
            pageLink.addEventListener('click', (e) => {
                e.preventDefault();
                currentPage = i;
                updateTable();
            });
            pageItem.appendChild(pageLink);
            pagination.appendChild(pageItem);
        }
    }

    document.getElementById('rows-per-page').addEventListener('change', (e) => {
        rowsPerPage = parseInt(e.target.value);
        currentPage = 1;
        updateTable();
    });

    setInterval(fetchEarthquakeData, 300000);
    fetchEarthquakeData();
</script>

</body>
</html>