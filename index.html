<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Earthquake Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet-geosearch@3.0.0/dist/geosearch.css">
    <style>
        #map { height: 600px; }
        #status-bar { height: 30px; background-color: #f8f9fa; display: flex; justify-content: space-between; align-items: center; padding: 0 10px; }
        #earthquake-table { margin-top: 20px; }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="status-bar">
        <span id="mouse-coordinates"></span>
        <button id="reset-view" class="btn btn-primary btn-sm">Reset View</button>
    </div>
    <div class="container">
        <div id="earthquake-table"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-geosearch@3.0.0/dist/geosearch.umd.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const map = L.map('map').setView([37.7749, -122.4194], 5); // Centered on San Francisco

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        const searchControl = new GeoSearch.GeoSearchControl({
            provider: new GeoSearch.OpenStreetMapProvider(),
            style: 'bar'
        });
        map.addControl(searchControl);

        document.getElementById('reset-view').onclick = () => {
            map.setView([37.7749, -122.4194], 5);
        };

        map.on('mousemove', function (e) {
            document.getElementById('mouse-coordinates').innerText = `Lat: ${e.latlng.lat.toFixed(4)}, Lng: ${e.latlng.lng.toFixed(4)}`;
        });

        async function fetchEarthquakeData() {
            const response = await fetch('https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_hour.geojson');
            const data = await response.json();
            return data.features;
        }

        function createPopupContent(feature) {
            const properties = feature.properties;
            return `
                <strong>Location:</strong> ${properties.place}<br>
                <strong>Magnitude:</strong> ${properties.mag}<br>
                <strong>Time:</strong> ${new Date(properties.time).toLocaleString()}<br>
            `;
        }

        async function initializeMap() {
            const earthquakeData = await fetchEarthquakeData();

            const markers = [];
            earthquakeData.forEach(feature => {
                const [lng, lat] = feature.geometry.coordinates;
                const marker = L.marker([lat, lng]).bindPopup(createPopupContent(feature));
                markers.push(marker);
                marker.addTo(map);
            });

            createTable(earthquakeData);
        }

        function createTable(earthquakeData) {
            const tableContainer = document.getElementById('earthquake-table');
            const table = document.createElement('table');
            table.className = 'table table-striped';

            const thead = document.createElement('thead');
            thead.innerHTML = `
                <tr>
                    <th>Location</th>
                    <th>Magnitude</th>
                    <th>Time</th>
                </tr>
            `;
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            earthquakeData.forEach(feature => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${feature.properties.place}</td>
                    <td>${feature.properties.mag}</td>
                    <td>${new Date(feature.properties.time).toLocaleString()}</td>
                `;
                tbody.appendChild(row);
            });
            table.appendChild(tbody);
            tableContainer.appendChild(table);

            // Add pagination
            $(table).after('<div id="nav"></div>');
            const rowsShown = 10;
            const rowsTotal = $(table).find('tbody tr').length;
            const numPages = Math.ceil(rowsTotal / rowsShown);
            $('#nav').append('<ul class="pagination"></ul>');
            for (let i = 0; i < numPages; i++) {
                const pageNum = i + 1;
                $('#nav ul').append(`<li class="page-item"><a class="page-link" href="#" rel="${i}">${pageNum}</a></li>`);
            }
            $(table).find('tbody tr').hide();
            $(table).find('tbody tr').slice(0, rowsShown).show();
            $('#nav ul li:first').addClass('active');
            $('#nav ul li a').bind('click', function (e) {
                e.preventDefault();
                $('#nav ul li').removeClass('active');
                $(this).parent().addClass('active');
                const currPage = $(this).attr('rel');
                const startItem = currPage * rowsShown;
                const endItem = startItem + rowsShown;
                $(table).find('tbody tr').css('opacity', '0.0').hide().slice(startItem, endItem)
                    .css('display', 'table-row').animate({ opacity: 1 }, 300);
            });
        }

        setInterval(initializeMap, 5 * 60 * 1000); // Refresh every 5 minutes
        initializeMap(); // Initial call
    </script>
</body>
</html>