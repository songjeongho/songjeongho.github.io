<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>USGS 지진 지도</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.Default.css" />
    <style>
        body { margin: 0; padding: 0; }
        #map { height: 100vh; width: 100%; }
        #status-bar { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            background: rgba(255,255,255,0.8); 
            padding: 10px; 
            display: flex; 
            justify-content: space-between;
        }
        .leaflet-popup-content-wrapper {
            background: rgba(255,255,255,0.9);
            color: #333;
            border-radius: 10px;
            padding: 10px;
            box-shadow: 0 3px 14px rgba(0,0,0,0.4);
        }
        .leaflet-popup-content {
            margin: 13px 19px;
            line-height: 1.4;
        }
        .leaflet-popup-tip {
            display: none;
        }
        .close-button {
            display: inline-block;
            padding: 5px 10px;
            background-color: #f44336;
            color: white;
            text-align: center;
            cursor: pointer;
            border-radius: 5px;
        }
        .search-container {
            position: absolute;
            top: 10px;
            left: 50px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .magnitude-filter {
            position: absolute;
            top: 10px;
            right: 50px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="status-bar">
        <span>마우스를 지도 위에 올려놓으세요</span>
        <span id="coordinates"></span>
    </div>
    <div class="search-container">
        <select id="region-select">
            <option value="">지역 선택</option>
            <option value="us">미국</option>
            <option value="jp">일본</option>
            <option value="kr">한국</option>
        </select>
        <button id="search-button">검색</button>
    </div>
    <div class="magnitude-filter">
        <label for="magnitude">최소 규모:</label>
        <input type="number" id="magnitude" min="0" max="10" step="0.1" value="0">
        <button id="filter-button">필터</button>
    </div>
    <button id="reset-button" style="position: absolute; bottom: 50px; right: 10px; z-index: 1000;">초기화</button>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.js"></script>
    <script>
        // 지도 초기화
        const map = L.map('map').setView([0, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // 마커 클러스터 그룹 초기화
        const markers = L.markerClusterGroup();

        // 지진 아이콘 정의
        const earthquakeIcon = L.icon({
            iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
            shadowSize: [41, 41]
        });

        // USGS API에서 지진 데이터 가져오기
        async function fetchEarthquakeData() {
            try {
                const response = await fetch('https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_week.geojson');
                const data = await response.json();
                return data.features;
            } catch (error) {
                console.error('지진 데이터를 가져오는 중 오류 발생:', error);
                alert('지진 데이터를 불러오는 데 실패했습니다. 다시 시도해 주세요.');
                return [];
            }
        }

        // 지진 데이터로 마커 생성
        function createMarkers(earthquakes) {
            markers.clearLayers();
            earthquakes.forEach(eq => {
                const coords = eq.geometry.coordinates;
                const marker = L.marker([coords[1], coords[0]], {icon: earthquakeIcon});
                
                marker.bindPopup(() => {
                    const popupContent = `
                        <h3>지진 정보</h3>
                        <p>규모: ${eq.properties.mag}</p>
                        <p>위치: ${eq.properties.place}</p>
                        <p>시간: ${new Date(eq.properties.time).toLocaleString()}</p>
                        <p>위도: ${coords[1]}</p>
                        <p>경도: ${coords[0]}</p>
                        <button class="close-button">닫기</button>
                    `;
                    const popup = L.popup({closeButton: false})
                        .setContent(popupContent);
                    
                    setTimeout(() => {
                        const closeButton = popup.getElement().querySelector('.close-button');
                        closeButton.addEventListener('click', () => {
                            map.closePopup();
                        });
                    }, 0);
                    
                    return popup;
                });
                
                markers.addLayer(marker);
            });
            map.addLayer(markers);
        }

        // 초기 데이터 로드
        fetchEarthquakeData().then(createMarkers);

        // 상태 바 업데이트
        map.on('mousemove', (e) => {
            document.getElementById('coordinates').textContent = `위도: ${e.latlng.lat.toFixed(4)}, 경도: ${e.latlng.lng.toFixed(4)}`;
        });

        // 지역 검색 기능
        document.getElementById('search-button').addEventListener('click', () => {
            const region = document.getElementById('region-select').value;
            let center, zoom;
            switch(region) {
                case 'us':
                    center = [39.8283, -98.5795];
                    zoom = 4;
                    break;
                case 'jp':
                    center = [36.2048, 138.2529];
                    zoom = 5;
                    break;
                case 'kr':
                    center = [35.9078, 127.7669];
                    zoom = 7;
                    break;
                default:
                    center = [0, 0];
                    zoom = 2;
            }
            map.flyTo(center, zoom, {
                animate: true,
                duration: 2
            });
        });

        // 규모 필터 기능
        document.getElementById('filter-button').addEventListener('click', async () => {
            const minMagnitude = parseFloat(document.getElementById('magnitude').value);
            const earthquakes = await fetchEarthquakeData();
            const filteredEarthquakes = earthquakes.filter(eq => eq.properties.mag >= minMagnitude);
            createMarkers(filteredEarthquakes);
        });

        // 초기화 버튼
        document.getElementById('reset-button').addEventListener('click', () => {
            map.setView([0, 0], 2);
            fetchEarthquakeData().then(createMarkers);
            document.getElementById('magnitude').value = 0;
        });

    </script>
</body>
</html>