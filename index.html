<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>USGS 지진 지도</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.Default.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.js"></script>
    <style>
        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        #map {
            height: calc(100% - 40px);
            width: 100%;
        }
        #status-bar {
            height: 40px;
            background-color: #f0f0f0;
            padding: 10px;
            box-sizing: border-box;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #coordinates {
            font-weight: bold;
        }
        #controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .info-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
            z-index: 2000;
            max-width: 80%;
            max-height: 80%;
            overflow-y: auto;
        }
        .info-popup h2 {
            margin-top: 0;
            color: #333;
        }
        .info-popup p {
            margin: 10px 0;
            color: #666;
        }
        .info-popup button {
            margin-top: 15px;
            padding: 5px 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .info-popup button:hover {
            background-color: #45a049;
        }
        select, button {
            margin: 5px;
            padding: 5px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="status-bar">
        <div>USGS 지진 지도</div>
        <div id="coordinates"></div>
    </div>
    <div id="controls">
        <select id="country-select">
            <option value="">국가 선택</option>
        </select>
        <select id="magnitude-select">
            <option value="">강도 선택</option>
            <option value="1">1+</option>
            <option value="2">2+</option>
            <option value="3">3+</option>
            <option value="4">4+</option>
            <option value="5">5+</option>
        </select>
        <button id="reset-button">초기화</button>
    </div>

    <script>
        // 지도 초기화
        const map = L.map('map').setView([0, 0], 2);
        let markers = L.markerClusterGroup();
        let initialView = { center: [0, 0], zoom: 2 };

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // 지진 아이콘
        const earthquakeIcon = L.icon({
            iconUrl: '/api/placeholder/25/25',
            iconSize: [25, 25],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
        });

        // USGS API에서 지진 데이터 가져오기
        async function fetchEarthquakeData() {
            try {
                const response = await fetch('https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_month.geojson');
                const data = await response.json();
                return data.features;
            } catch (error) {
                console.error('지진 데이터를 가져오는 중 오류 발생:', error);
                alert('지진 데이터를 가져오는 데 실패했습니다. 다시 시도해 주세요.');
                return [];
            }
        }

        // 마커 생성 및 지도에 추가
        function createMarkers(earthquakes) {
            markers.clearLayers();
            earthquakes.forEach(eq => {
                const { coordinates } = eq.geometry;
                const { mag, place, time, url } = eq.properties;
                const marker = L.marker([coordinates[1], coordinates[0]], { icon: earthquakeIcon });
                
                marker.on('click', () => showEarthquakeInfo(eq));
                markers.addLayer(marker);
            });
            map.addLayer(markers);
        }

        // 지진 정보 팝업 표시
        function showEarthquakeInfo(eq) {
            const { coordinates } = eq.geometry;
            const { mag, place, time, url } = eq.properties;
            const infoPopup = document.createElement('div');
            infoPopup.className = 'info-popup';
            infoPopup.innerHTML = `
                <h2>지진 정보</h2>
                <p><strong>위치:</strong> ${place}</p>
                <p><strong>규모:</strong> ${mag}</p>
                <p><strong>발생 시간:</strong> ${new Date(time).toLocaleString()}</p>
                <p><strong>위도:</strong> ${coordinates[1]}</p>
                <p><strong>경도:</strong> ${coordinates[0]}</p>
                <p><a href="${url}" target="_blank">USGS 상세 정보</a></p>
                <button onclick="closeInfoPopup()">닫기</button>
            `;
            document.body.appendChild(infoPopup);
        }

        // 정보 팝업 닫기
        function closeInfoPopup() {
            const popup = document.querySelector('.info-popup');
            if (popup) {
                document.body.removeChild(popup);
            }
        }

        // 마우스 이벤트 처리
        map.on('mousemove', (e) => {
            const { lat, lng } = e.latlng;
            document.getElementById('coordinates').textContent = `위도: ${lat.toFixed(4)}, 경도: ${lng.toFixed(4)}`;
        });

        // 국가 선택 옵션 생성
        async function populateCountrySelect(earthquakes) {
            const countrySelect = document.getElementById('country-select');
            const countries = new Set(earthquakes.map(eq => eq.properties.place.split(', ').pop().trim()));
            countries.forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                option.textContent = country;
                countrySelect.appendChild(option);
            });
        }

        // 국가 선택 이벤트 처리
        document.getElementById('country-select').addEventListener('change', (e) => {
            const selectedCountry = e.target.value;
            if (selectedCountry) {
                const filteredEarthquakes = earthquakeData.filter(eq => 
                    eq.properties.place.toLowerCase().includes(selectedCountry.toLowerCase())
                );
                createMarkers(filteredEarthquakes);
                if (filteredEarthquakes.length > 0) {
                    const bounds = L.latLngBounds(filteredEarthquakes.map(eq => [eq.geometry.coordinates[1], eq.geometry.coordinates[0]]));
                    map.flyToBounds(bounds, { padding: [50, 50] });
                }
            } else {
                createMarkers(earthquakeData);
                map.flyTo(initialView.center, initialView.zoom);
            }
        });

        // 강도 선택 이벤트 처리
        document.getElementById('magnitude-select').addEventListener('change', (e) => {
            const selectedMagnitude = parseFloat(e.target.value);
            const filteredEarthquakes = earthquakeData.filter(eq => eq.properties.mag >= selectedMagnitude);
            createMarkers(filteredEarthquakes);
        });

        // 초기화 버튼 이벤트 처리
        document.getElementById('reset-button').addEventListener('click', () => {
            document.getElementById('country-select').value = '';
            document.getElementById('magnitude-select').value = '';
            createMarkers(earthquakeData);
            map.flyTo(initialView.center, initialView.zoom);
        });

        // 메인 함수
        let earthquakeData = [];
        async function init() {
            try {
                earthquakeData = await fetchEarthquakeData();
                createMarkers(earthquakeData);
                populateCountrySelect(earthquakeData);
            } catch (error) {
                console.error('초기화 중 오류 발생:', error);
                alert('애플리케이션을 초기화하는 데 실패했습니다. 페이지를 새로고침 해주세요.');
            }
        }

        init();
    </script>
</body>
</html>