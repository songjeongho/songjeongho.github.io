<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Earthquake Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
    <style>
        #map { height: 600px; }
        #status-bar { position: fixed; bottom: 0; width: 100%; background: #ccc; padding: 10px; text-align: center; }
        #table-container { margin-top: 20px; }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="status-bar">Loading...</div>
    <div id="table-container" class="container">
        <div id="table-controls" class="d-flex justify-content-between align-items-center">
            <div>Total: <span id="total-records"></span></div>
            <div>Page: <span id="current-page"></span></div>
            <div>
                Rows per page:
                <select id="rows-per-page">
                    <option value="5">5</option>
                    <option value="20">20</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
            </div>
        </div>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Time</th>
                    <th>Magnitude</th>
                    <th>Location</th>
                </tr>
            </thead>
            <tbody id="earthquake-table-body">
                <!-- Rows will be populated here -->
            </tbody>
        </table>
        <nav>
            <ul id="pagination" class="pagination">
                <!-- Pagination will be populated here -->
            </ul>
        </nav>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script>
        const map = L.map('map').setView([37.7749, -122.4194], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        const geocoder = L.Control.geocoder().addTo(map);

        const statusBar = document.getElementById('status-bar');
        const earthquakeTableBody = document.getElementById('earthquake-table-body');
        const totalRecordsElement = document.getElementById('total-records');
        const currentPageElement = document.getElementById('current-page');
        const rowsPerPageElement = document.getElementById('rows-per-page');
        const paginationElement = document.getElementById('pagination');

        let earthquakes = [];
        let currentPage = 1;
        let rowsPerPage = parseInt(rowsPerPageElement.value);

        map.on('mousemove', function(e) {
            statusBar.innerText = `Lat: ${e.latlng.lat}, Lng: ${e.latlng.lng}`;
        });

        rowsPerPageElement.addEventListener('change', function() {
            rowsPerPage = parseInt(this.value);
            currentPage = 1;
            updateTable();
        });

        function fetchEarthquakeData() {
            fetch('https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_hour.geojson')
                .then(response => response.json())
                .then(data => {
                    earthquakes = data.features;
                    updateTable();
                    updateMap();
                    statusBar.innerText = 'Update completed';
                });
        }

        function updateMap() {
            map.eachLayer(layer => {
                if (layer instanceof L.Marker) {
                    map.removeLayer(layer);
                }
            });

            earthquakes.forEach(eq => {
                const [lng, lat] = eq.geometry.coordinates;
                const marker = L.marker([lat, lng]).addTo(map);
                marker.bindPopup(`
                    <strong>Location:</strong> ${eq.properties.place}<br>
                    <strong>Magnitude:</strong> ${eq.properties.mag}<br>
                    <strong>Time:</strong> ${new Date(eq.properties.time).toLocaleString()}
                `);
            });
        }

        function updateTable() {
            earthquakeTableBody.innerHTML = '';
            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const currentPageData = earthquakes.slice(start, end);

            currentPageData.forEach(eq => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${new Date(eq.properties.time).toLocaleString()}</td>
                    <td>${eq.properties.mag}</td>
                    <td>${eq.properties.place}</td>
                `;
                row.addEventListener('click', () => {
                    const [lng, lat] = eq.geometry.coordinates;
                    map.setView([lat, lng], 8);
                    L.popup()
                        .setLatLng([lat, lng])
                        .setContent(`
                            <strong>Location:</strong> ${eq.properties.place}<br>
                            <strong>Magnitude:</strong> ${eq.properties.mag}<br>
                            <strong>Time:</strong> ${new Date(eq.properties.time).toLocaleString()}
                        `)
                        .openOn(map);
                });
                earthquakeTableBody.appendChild(row);
            });

            totalRecordsElement.innerText = earthquakes.length;
            currentPageElement.innerText = currentPage;
            updatePagination();
        }

        function updatePagination() {
            paginationElement.innerHTML = '';
            const totalPages = Math.ceil(earthquakes.length / rowsPerPage);

            for (let i = 1; i <= totalPages; i++) {
                const li = document.createElement('li');
                li.classList.add('page-item');
                if (i === currentPage) {
                    li.classList.add('active');
                }
                const a = document.createElement('a');
                a.classList.add('page-link');
                a.innerText = i;
                a.addEventListener('click', () => {
                    currentPage = i;
                    updateTable();
                });
                li.appendChild(a);
                paginationElement.appendChild(li);
            }
        }

        setInterval(fetchEarthquakeData, 5 * 60 * 1000);
        fetchEarthquakeData();
    </script>
</body>
</html>