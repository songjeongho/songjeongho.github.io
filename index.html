<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>USGS 지진 정보 지도 (개선된 마커 및 팝업)</title>
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; }
        #map { flex-grow: 1; width: 100%; }
        #legend {
            position: absolute;
            bottom: 40px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
            font-family: Arial, sans-serif;
            font-size: 12px;
            z-index: 1;
        }
        .legend-item {
            margin-bottom: 5px;
        }
        .legend-color {
            display: inline-block;
            width: 15px;
            height: 15px;
            margin-right: 5px;
            vertical-align: middle;
            border: 1px solid #000;
        }
        #status-bar {
            height: 30px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            font-family: Arial, sans-serif;
            font-size: 14px;
            line-height: 30px;
            z-index: 2;
        }
        .mapboxgl-popup-content {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
            padding: 15px;
            font-family: Arial, sans-serif;
        }
        .popup-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        .popup-info {
            font-size: 14px;
            color: #666;
        }
        .popup-magnitude {
            font-size: 18px;
            font-weight: bold;
            color: #e74c3c;
        }
    </style>
</head>
<body>
    <div id='map'></div>
    <div id='legend'>
        <h3>지진 규모</h3>
        <div class='legend-item'><span class='legend-color' style='background: #00FF00;'></span> 0-3</div>
        <div class='legend-item'><span class='legend-color' style='background: #FFFF00;'></span> 3-4</div>
        <div class='legend-item'><span class='legend-color' style='background: #FFA500;'></span> 4-5</div>
        <div class='legend-item'><span class='legend-color' style='background: #FF0000;'></span> 5+</div>
        <h3>클러스터</h3>
        <div class='legend-item'><span class='legend-color' style='background: #51bbd6;'></span> &lt; 100</div>
        <div class='legend-item'><span class='legend-color' style='background: #f1f075;'></span> 100-750</div>
        <div class='legend-item'><span class='legend-color' style='background: #f28cb1;'></span> 750+</div>
    </div>
    <div id='status-bar'>위도: 0.00000°, 경도: 0.00000°</div>
    <script>
        mapboxgl.accessToken = 'pk.eyJ1Ijoic3RldmUtc29uZzAxIiwiYSI6ImNtMmJzbjMwajB4cnEybHF3MmZ2enBzMGUifQ.7DuFIEhjnHvCgodL3cigbg'; // Mapbox 액세스 토큰을 여기에 입력하세요
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/satellite-streets-v12',
            center: [0, 0],
            zoom: 1.5,
            minZoom: 1,
            maxBounds: [
                [-180, -85],
                [180, 85]
            ]
        });

        map.on('load', function () {
            map.addSource('earthquakes', {
                type: 'geojson',
                data: 'https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_week.geojson',
                cluster: true,
                clusterMaxZoom: 14,
                clusterRadius: 50
            });

            map.addLayer({
                id: 'clusters',
                type: 'circle',
                source: 'earthquakes',
                filter: ['has', 'point_count'],
                paint: {
                    'circle-color': [
                        'step',
                        ['get', 'point_count'],
                        '#51bbd6',
                        100,
                        '#f1f075',
                        750,
                        '#f28cb1'
                    ],
                    'circle-radius': [
                        'step',
                        ['get', 'point_count'],
                        20,
                        100,
                        30,
                        750,
                        40
                    ],
                    'circle-stroke-width': 2,
                    'circle-stroke-color': '#fff'
                }
            });

            map.addLayer({
                id: 'cluster-count',
                type: 'symbol',
                source: 'earthquakes',
                filter: ['has', 'point_count'],
                layout: {
                    'text-field': '{point_count_abbreviated}',
                    'text-font': ['DIN Offc Pro Medium', 'Arial Unicode MS Bold'],
                    'text-size': 12
                },
                paint: {
                    'text-color': '#ffffff'
                }
            });

            map.addLayer({
                id: 'unclustered-point',
                type: 'circle',
                source: 'earthquakes',
                filter: ['!', ['has', 'point_count']],
                paint: {
                    'circle-color': [
                        'interpolate',
                        ['linear'],
                        ['get', 'mag'],
                        0, '#00FF00',
                        3, '#FFFF00',
                        4, '#FFA500',
                        5, '#FF0000'
                    ],
                    'circle-radius': [
                        'interpolate',
                        ['linear'],
                        ['get', 'mag'],
                        0, 5,
                        6, 20
                    ],
                    'circle-stroke-width': 1,
                    'circle-stroke-color': '#fff',
                    'circle-opacity': 0.8
                }
            });

            // 클러스터 클릭 이벤트
            map.on('click', 'clusters', function (e) {
                var features = map.queryRenderedFeatures(e.point, { layers: ['clusters'] });
                var clusterId = features[0].properties.cluster_id;
                map.getSource('earthquakes').getClusterExpansionZoom(clusterId, function (err, zoom) {
                    if (err) return;
                    map.easeTo({
                        center: features[0].geometry.coordinates,
                        zoom: zoom
                    });
                });
            });

            // 개별 지진 클릭 이벤트
            map.on('click', 'unclustered-point', function (e) {
                var coordinates = e.features[0].geometry.coordinates.slice();
                var mag = e.features[0].properties.mag;
                var place = e.features[0].properties.place;
                var time = new Date(e.features[0].properties.time).toLocaleString();

                new mapboxgl.Popup()
                    .setLngLat(coordinates)
                    .setHTML(`
                        <div class="popup-title">지진 정보</div>
                        <div class="popup-info">
                            <strong>규모:</strong> <span class="popup-magnitude">${mag}</span><br>
                            <strong>위치:</strong> ${place}<br>
                            <strong>시간:</strong> ${time}
                        </div>
                    `)
                    .addTo(map);
            });

            // 마우스 커서 변경
            map.on('mouseenter', 'clusters', function () {
                map.getCanvas().style.cursor = 'pointer';
            });
            map.on('mouseleave', 'clusters', function () {
                map.getCanvas().style.cursor = '';
            });
            map.on('mouseenter', 'unclustered-point', function () {
                map.getCanvas().style.cursor = 'pointer';
            });
            map.on('mouseleave', 'unclustered-point', function () {
                map.getCanvas().style.cursor = '';
            });

            // 마우스 이동 시 좌표 업데이트
            map.on('mousemove', function (e) {
                document.getElementById('status-bar').innerHTML = 
                    '위도: ' + e.lngLat.lat.toFixed(5) + '°, 경도: ' + e.lngLat.lng.toFixed(5) + '°';
            });
        });
    </script>
</body>
</html>
